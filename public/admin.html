<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin Inscripciones</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-screen-lg mx-auto">
    <h1 class="text-2xl font-bold mb-4">üìã Inscripciones Torneo P√°del</h1>
    <p id="loading" class="mb-4 text-gray-500">Cargando inscripciones...</p>
    <button id="pdfBtn" class="mb-4 bg-blue-600 text-white px-4 py-2 rounded hidden">Descargar PDF</button>
    <div class="overflow-x-auto">
    <table id="tabla" class="min-w-full bg-white shadow rounded-lg">
      <thead class="bg-gray-200 text-gray-700">
        <tr>
          <th class="px-4 py-2">Fecha</th>
          <th class="px-4 py-2">Miembro 1</th>
          <th class="px-4 py-2">Miembro 2</th>
          <th class="px-4 py-2">Categor√≠a</th>
          <th class="px-4 py-2">Disponibilidad</th>
          <th class="px-4 py-2">Tel√©fono</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    </div>
  </div>

  <script>
    const loading = document.getElementById('loading');
    const pdfBtn = document.getElementById('pdfBtn');
    let submissions = [];
    fetch('/.netlify/functions/get-submissions')
      .then(r => {
        if (!r.ok) throw new Error('Error al obtener las inscripciones');
        return r.json();
      })
      .then(data => {
        submissions = data;
        loading.remove();
        const tbody = document.querySelector('#tabla tbody');
        if (!data.length) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Sin inscripciones</td></tr>';
        } else {
          data.forEach(entry => {
            const d = new Date(entry.created_at).toLocaleString();
            const miembro1 = entry.data["Miembro 1"];
            const miembro2 = entry.data["Miembro 2"];
            const categoria = entry.data["Categor√≠a"];
            const disponibilidad = entry.data["Disponibilidad"];
            const telefono = entry.data["Tel√©fono"];
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="border px-4 py-2">${d}</td>
              <td class="border px-4 py-2">${miembro1}</td>
              <td class="border px-4 py-2">${miembro2}</td>
              <td class="border px-4 py-2">${categoria}</td>
              <td class="border px-4 py-2">${disponibilidad}</td>
              <td class="border px-4 py-2">${telefono}</td>
            `;
            tbody.appendChild(tr);
          });
        }
        pdfBtn.classList.remove('hidden');
        pdfBtn.addEventListener('click', () => {
          const body = [
            ['Fecha','Miembro 1','Miembro 2','Categor√≠a','Disponibilidad','Tel√©fono'],
            ...submissions.map(entry => [
              new Date(entry.created_at).toLocaleString(),
              entry.data['Miembro 1'],
              entry.data['Miembro 2'],
              entry.data['Categor√≠a'],
              entry.data['Disponibilidad'],
              entry.data['Tel√©fono']
            ])
          ];
          const docDefinition = {
            content: [
              { text: 'Inscripciones Torneo P√°del', style: 'header' },
              {
                table: {
                  headerRows: 1,
                  body
                }
              }
            ],
            styles: {
              header: { fontSize: 18, bold: true, margin: [0,0,0,10] }
            }
          };
          pdfMake.createPdf(docDefinition).download('inscripciones.pdf');
        });
      })
      .catch(err => {
        console.error(err);
        loading.remove();
        const tbody = document.querySelector('#tabla tbody');
        tbody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-red-500">Error: ${err.message}</td></tr>`;
      });
  </script>
</body>
</html>
